---
- name: "create admins group"
  ansible.builtin.group:
    name: "admins"
    state: "present"

- name: "create docker group"
  ansible.builtin.group:
    name: "docker"
    state: "present"
    gid: 1750

- name: "create admins group in sudoers setup"
  ansible.builtin.lineinfile:
    dest: "/etc/sudoers"
    state: "present"
    regexp: "^%admins"
    line: "%admins ALL=(ALL) NOPASSWD: ALL"

- name: "create users"
  ansible.builtin.user:
    name: "{{ item.username }}"
    groups: "admins"
    shell: "{{ item.shell }}"
    state: "present"
    password: "!"
  with_items: "{{ users }}"

- name: debug
  ansible.builtin.debug:
    msg: "{{ item }}"
  with_items:
    - "{{ users }}"

- name: "add ssh keys of the user"
  ansible.posix.authorized_key:
    user: "{{ item.username }}"
    key: "{{ item.ssh_pub_keys | join('\n') }}"
    exclusive: true
  with_items:
    - "{{ users }}"
